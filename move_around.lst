                        ; --------------------------------------
                        ; zasm: assemble "move_around.z80"
                        ; date: 2020-06-19 23:07:07
                        ; --------------------------------------


                        
00F7:                   ClearDisplay equ 0xf7
007C:                   PIOOut equ 0x7c
0348:                   ApplicationReturn equ 0x348
                        ; set caret anywhere on the screen
                        ; b - offset, 64 (0x40) is 2nd line
                        ; c - offset on the line
011C:                   SetCaretRaw equ 0x11C
0005:                   DSP_DW	equ	0x5
047B:                   OutHex equ $047B
0497:                   DisableCursor equ $0497
04F8:                   Wait_PS2ScanCode equ $04F8
                        ; there are RAM mapped
083E:                   STATE_KEYSTROKE equ $083E
0842:                   STATE_SCANCODE equ $0842
                        
                        
                        
                        #target bin
0882:                   #code _CODE, 0x882, 0x6fe	; 0x882 is the allocated memory for application of size 0x6fe (2 bytes reserved for app size)
                        #code _CODE
                        
                        ; app entry point
0882: C34F09   [10]     	jp main
                        
0885: 00                xpos defb 0
0886: 00                ypos defb 0
                        
0887:                   rawout:
0887: 1605     [ 7]     	ld d, DSP_DW
0889: CD7C00   [24]     	call PIOOut
088C: C9       [34]     	ret
                        
088D:                   moveup:
088D: 218608   [10]     	ld hl, ypos
0890: 7E       [17]     	ld a, (hl)
0891: F600     [24]     	or 0
0893: C8       [29|35]  	ret z
0894: 35       [40]     	dec (hl)
0895: C9       [50]     	ret
                        
0896:                   movedown:
0896: 218608   [10]     	ld hl, ypos
0899: 7E       [17]     	ld a, (hl)
089A: D601     [24]     	sub 1
089C: C8       [29|35]  	ret z
089D: 34       [40]     	inc (hl)
089E: C9       [50]     	ret
                        
089F:                   moveleft:
089F: 218508   [10]     	ld hl, xpos
08A2: 7E       [17]     	ld a, (hl)
08A3: F600     [24]     	or 0
08A5: C8       [29|35]  	ret z
08A6: 35       [40]     	dec (hl)
08A7: C9       [50]     	ret
                        
08A8:                   moveright:
08A8: 218508   [10]     	ld hl, xpos
08AB: 7E       [17]     	ld a, (hl)
08AC: D60F     [24]     	sub 15
08AE: C8       [29|35]  	ret z
08AF: 34       [40]     	inc (hl)
08B0: C9       [50]     	ret
                         
08B1:                   reset_2nd_line:
08B1: C5       [11]     	push bc
08B2: 0640     [18]     	ld b, 64
08B4: 0E00     [25]     	ld c, 0
08B6: CD1C01   [42]     	call SetCaretRaw
08B9: C1       [52]     	pop bc
08BA: C9       [62]     	ret
                        
08BB:                   output_keycode:
08BB: C5       [11]     	push bc
08BC: D5       [22]     	push de
08BD: E5       [33]     	push hl
                        #local
                        	; output currently pressed key code on the 2nd line of lcd
08BE: 0640     [40]     	ld b, 64
08C0: 0E00     [47]     	ld c, 0
08C2: CD1C01   [64]     	call SetCaretRaw
                        
08C5: 213E08   [74]     	ld hl, STATE_KEYSTROKE
                        	; quick check if we have any keystroke chars
08C8: 7E       [81]     	ld a, (hl)
08C9: F600     [88]     	or 0
08CB: CAD708   [98|98]  	jp z, done
08CE: 47       [102]    	ld b, a
08CF: 23       [108]    	inc hl
08D0:                   outcode:	
08D0: 7E       [ 7]     	ld a, (hl)
08D1: CD7B04   [24]     	call OutHex
08D4: 23       [30]     	inc hl
08D5: 10F9     [38|43]  	djnz outcode
                        
08D7:                   done:	
                        #endlocal
                        	; transform A register to d & e codes
08D7: E1       [10]     	pop hl
08D8: D1       [20]     	pop de
08D9: C1       [30]     	pop bc
08DA: C9       [40]     	ret
                        
08DB:                   move:
                        #local
08DB: 3A3F08   [13]     	ld a, (STATE_KEYSTROKE + 1)
                        
08DE: F5       [24]     	push af
08DF: D66B     [31]     	sub 6bh
08E1: CC9F08   [41|48]  	call z, moveleft
08E4: F1       [51]     	pop af
                        
08E5: F5       [62]     	push af
08E6: D674     [69]     	sub 74h
08E8: CCA808   [79|86]  	call z, moveright
08EB: F1       [89]     	pop af
                        
08EC: F5       [100]    	push af
08ED: D675     [107]    	sub 75h
08EF: CC8D08   [117|124]	call z, moveup
08F2: F1       [127]    	pop af
                        
08F3: F5       [138]    	push af
08F4: D672     [145]    	sub 72h
08F6: CC9608   [155|162]	call z, movedown
08F9: F1       [165]    	pop af
                        
                        #endlocal
08FA: C9       [175]    	ret
                        
08FB:                   reset_pos:
08FB: E5       [11]     	push hl
08FC: 218508   [21]     	ld hl, xpos
08FF: 3600     [31]     	ld (hl), 0
0901: 218608   [41]     	ld hl, ypos
0904: 3600     [51]     	ld (hl), 0
0906: E1       [61]     	pop hl
0907: C9       [71]     	ret
                        
0908:                   draw_player:
0908: C5       [11]     	push bc
0909: E5       [22]     	push hl
090A: D5       [33]     	push de
                        #local
090B: 3A8608   [46]     	ld a, (ypos)
090E: 47       [50]     	ld b, a
090F: 3E00     [57]     	ld a, 0
0911:                   moverow:
0911: C640     [ 7]     	add a, 64
0913: 10FC     [15|20]  	djnz moverow
0915: 47       [19]     	ld b, a
                        	
0916: 218508   [29]     	ld hl, xpos
0919: 4E       [36]     	ld c, (hl)
                        
091A: CD1C01   [53]     	call SetCaretRaw
                        
091D: 1E23     [60]     	ld e, '#'
091F: 1605     [67]     	ld d, DSP_DW
0921: CD7C00   [84]     	call PIOOut
                        
                        #endlocal
0924: D1       [94]     	pop de
0925: E1       [104]    	pop hl
0926: C1       [114]    	pop bc
0927: C9       [124]    	ret
                        
0928:                   draw_player_location:
0928: 0640     [ 7]     	ld b, 64
092A: 0E0B     [14]     	ld c, 11
092C: CD1C01   [31]     	call SetCaretRaw
                        
092F: 1605     [38]     	ld d, DSP_DW
0931: 1E5B     [45]     	ld e, '['
0933: CD7C00   [62]     	call PIOOut
                        
0936: 3A8508   [75]     	ld a, (xpos)
0939: CD7B04   [92]     	call OutHex
                        
093C: 1E2C     [99]     	ld e, ','
093E: CD7C00   [116]    	call PIOOut
                        
0941: 3A8608   [129]    	ld a, (ypos)
0944: CD7B04   [146]    	call OutHex
                        
0947: 1605     [153]    	ld d, DSP_DW
0949: 1E5D     [160]    	ld e, ']'
094B: CD7C00   [177]    	call PIOOut
                        
094E: C9       [187]    	ret	
                        
094F:                   main:
094F: 213E08   [10]     	ld hl, STATE_KEYSTROKE
0952: 3600     [20]     	ld (hl), 0
0954: CDF700   [37]     	call ClearDisplay
0957: CDFB08   [54]     	call reset_pos
095A: CD9704   [71]     	call DisableCursor
                        
                        
095D:                   runloop:
095D: CDF700   [17]     	call ClearDisplay
                        
0960: CDBB08   [34]     	call output_keycode
                        
                        	; render
0963: CD2809   [51]     	call draw_player_location
0966: CD0809   [68]     	call draw_player
                        
                        	; wait for input
                        	; call wait_keystroke
                        
0969: CDF804   [85]     	call Wait_PS2ScanCode
096C: CD7909   [102]    	call scancode_to_keystroke
                        
                        	; move
096F: CDDB08   [119]    	call move
                        
0972: C35D09   [129]    	jp runloop
                        
0975:                   exit:
                        	;halt
0975: C34803   [10]     	jp ApplicationReturn
                        
                        
0978:                   write_player_char_to_cgram:
                        	; CGRAM address is b0000*000..b0000*111 is custom chars
                        	; that gives us 0x00..0x7, so 8 custom characters in CGRAM
                        
0978: C9       [10]     	ret
                        
                        
0979:                   scancode_to_keystroke:
0979: E5       [11]     	push hl
097A: D5       [22]     	push de
097B: C5       [33]     	push bc
                        
                        	; test only => copy pure scancode into keystroke
097C: 113E08   [43]     	ld de, STATE_KEYSTROKE
097F: 214208   [53]     	ld hl, STATE_SCANCODE
0982: 0600     [60]     	ld b, 0
0984: 0E04     [67]     	ld c, 4
0986: EDB0     [83|21]  	ldir
                        
0988: C1       [93]     	pop bc
0989: D1       [103]    	pop de
098A: E1       [113]    	pop hl
098B: C9       [123]    	ret
                        


; +++ segments +++

#CODE _CODE    = $0882 =  2178,  size = $06FE =  1790

; +++ global symbols +++

ApplicationReturn     = $0348 =   840          move_around.z80:4
ClearDisplay          = $00F7 =   247          move_around.z80:2
DSP_DW                = $0005 =     5          move_around.z80:9
DisableCursor         = $0497 =  1175          move_around.z80:11
OutHex                = $047B =  1147          move_around.z80:10
PIOOut                = $007C =   124          move_around.z80:3
STATE_KEYSTROKE       = $083E =  2110          move_around.z80:14
STATE_SCANCODE        = $0842 =  2114          move_around.z80:15
SetCaretRaw           = $011C =   284          move_around.z80:8
Wait_PS2ScanCode      = $04F8 =  1272          move_around.z80:12
_CODE                 = $0882 =  2178  _CODE   move_around.z80:19 (unused)
_CODE_end             = $0F80 =  3968  _CODE   move_around.z80:19 (unused)
_CODE_size            = $06FE =  1790  _CODE   move_around.z80:19 (unused)
draw_player           = $0908 =  2312  _CODE   move_around.z80:141
draw_player_location  = $0928 =  2344  _CODE   move_around.z80:169
exit                  = $0975 =  2421  _CODE   move_around.z80:221 (unused)
main                  = $094F =  2383  _CODE   move_around.z80:193
move                  = $08DB =  2267  _CODE   move_around.z80:105
movedown              = $0896 =  2198  _CODE   move_around.z80:42
moveleft              = $089F =  2207  _CODE   move_around.z80:50
moveright             = $08A8 =  2216  _CODE   move_around.z80:58
moveup                = $088D =  2189  _CODE   move_around.z80:34
output_keycode        = $08BB =  2235  _CODE   move_around.z80:74
rawout                = $0887 =  2183  _CODE   move_around.z80:29 (unused)
reset_2nd_line        = $08B1 =  2225  _CODE   move_around.z80:66 (unused)
reset_pos             = $08FB =  2299  _CODE   move_around.z80:132
runloop               = $095D =  2397  _CODE   move_around.z80:201
scancode_to_keystroke = $0979 =  2425  _CODE   move_around.z80:233
write_player_char_to_cgram = $0978 =  2424  _CODE   move_around.z80:226 (unused)
xpos                  = $0885 =  2181  _CODE   move_around.z80:26
ypos                  = $0886 =  2182  _CODE   move_around.z80:27

; +++ local symbols +++

done    = $08D7 =  2263  _CODE   move_around.z80:97
outcode = $08D0 =  2256  _CODE   move_around.z80:91

; +++ local symbols +++


; +++ local symbols +++

moverow = $0911 =  2321  _CODE   move_around.z80:149


total time: 0.0036 sec.
no errors
